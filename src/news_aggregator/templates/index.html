{% extends "base.html" %}

{% block title %}Newsletter Monitor - Home{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        {% if not app_ready %}
            <div class="alert alert-warning" role="alert">
                <h4 class="alert-heading">Application not ready</h4>
                <p>The application is still initializing. Please try again in a few moments.</p>
            </div>
        {% else %}
            {% if is_configured and active_topic %}
                <div class="status-container">
                    <h3>Active monitoring</h3>
                    <p class="lead">Currently monitoring for: <strong>{{ active_topic }}</strong></p>
                    <p>Status updates are sent to: <strong>{{ user_email }}</strong></p>
                    
                    {% if last_execution %}
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <p>Last update: <strong>{{ last_execution }}</strong></p>
                            </div>
                            <div class="col-md-6">
                                <p>Next update: <strong>{{ next_execution }}</strong> 
                                {% if time_remaining %}
                                    (in {{ time_remaining }})
                                {% endif %}
                                </p>
                            </div>
                        </div>
                    {% endif %}
                    
                    <form action="{{ url_for('stop_newsletter') }}" method="post" class="mt-3">
                        <button type="submit" class="btn btn-danger">Stop Monitoring</button>
                    </form>
                </div>
            {% else %}
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="form-container">
                            <h3>Configure Newsletter</h3>
                            {% if not is_configured %}
                                <form method="post" action="{{ url_for('index') }}">
                                    <input type="hidden" name="setup" value="1">
                                    <div class="mb-3">
                                        <label for="tavily_api_key" class="form-label">Tavily API Key</label>
                                        <input type="password" class="form-control" id="tavily_api_key" name="tavily_api_key" required>
                                        <div class="form-text">Get a key from <a href="https://tavily.com" target="_blank">Tavily</a></div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="gemini_api_key" class="form-label">Gemini API Key</label>
                                        <input type="password" class="form-control" id="gemini_api_key" name="gemini_api_key" required>
                                        <div class="form-text">Get a key from <a href="https://aistudio.google.com" target="_blank">Google AI Studio</a></div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="user_email" class="form-label">Your Email Address</label>
                                        <input type="email" class="form-control" id="user_email" name="user_email" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Save Configuration</button>
                                </form>
                            {% else %}
                                <div class="alert alert-success">
                                    Configuration saved for: <strong>{{ user_email }}</strong>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                {% if is_configured %}
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-container">
                                <h3>Start Newsletter</h3>
                                <form method="post" action="{{ url_for('index') }}">
                                    <input type="hidden" name="topic" value="">
                                    <div class="mb-3">
                                        <label for="topic" class="form-label">Topic to Monitor</label>
                                        <input type="text" class="form-control" id="topic" name="topic" required 
                                               placeholder="e.g., Artificial Intelligence, Climate Change, Quantum Computing">
                                        <div class="form-text">Enter a topic you want to receive updates about</div>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Start Monitoring</button>
                                </form>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
{% if active_topic %}
<script>
    // Refresh status every 30 seconds
    setInterval(function() {
        fetch('{{ url_for("api_status") }}')
            .then(response => response.json())
            .then(data => {
                if (data.time_remaining) {
                    document.querySelector('p:contains("Next update")').innerHTML = 
                        `Next update: <strong>${data.next_execution}</strong> (in ${data.time_remaining})`;
                }
            })
            .catch(error => console.error('Error fetching status:', error));
    }, 30000);
</script>
{% endif %}
{% endblock %}